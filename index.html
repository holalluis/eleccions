<!doctype html><html><head>
  <meta charset=utf8>
  <meta name=viewport content="width=device-width">
  <title>Eleccions</title>
  <style>
    body{
      font-family:Charter,serif;
      font-family: Roboto Slab, Roboto, Calibri, Corbel, sans-serif;
      max-width:80ch;
      padding:1rem;
      margin:auto;
    }
    table{border-collapse:collapse;margin-right:5px}
    td,th{border:1px solid #ccc}
    th{background:#eee}
    .numero{
      text-align:right;
    }
  </style>
</head><body><center>
<h1>Eleccions 2019</h1>
<h2>Combinacions possibles amb majoria (<span id=combs>calculant...</span>)</h2>
<h5>Selecciona partits per veure si poden formar combinacions amb majoria</h5>
<main style=display:flex>
  <table>
    <tr><th colspan=2>Partit<th>Escons<th>Inclòs
    <tbody id=partits></tbody>
  </table>
  <table>
    <tr><th>Pacte<th>Suma escons
    <tbody id=pactes>
      <tr><td colspan=3>calculant...
    </tbody>
  </table>
</main>

<script src="calculs.js"></script>
<script>
  //calcula total escons i majoria
  let total = partits.map(p=>p.escons).reduce((p,c)=>(p+c));
  let majoria = total/2+1;

  function omple_taula_partits(){
    let taula_partits = document.querySelector('#partits');

    //omple taula partits
    partits.forEach(p=>{
      let newRow = taula_partits.insertRow(-1);
      newRow.insertCell(-1).outerHTML=`<td style=background:${p.color}>&emsp;`
      newRow.insertCell(-1).innerHTML=p.nom;
      newRow.insertCell(-1).outerHTML=`<td class=numero>${p.escons}`;
      //crea checkbox per incloure o no el partit
      let newCell=newRow.insertCell(-1);
      let checkbox = document.createElement('input'); newCell.appendChild(checkbox);
      checkbox.type="checkbox";
      checkbox.checked=p.inclos;
      checkbox.onchange=function(){
        p.inclos = checkbox.checked;
        omple_taula_pactes();
      };
    });

    //inserta total escons i majoria a baix
    let newRow = taula_partits.insertRow(-1);
    newRow.insertCell(-1).outerHTML="<td colspan=2>total";
    newRow.insertCell(-1).outerHTML=`<td colspan=2 class=numero>${total}`
    newRow = taula_partits.insertRow(-1);
    newRow.insertCell(-1).outerHTML="<td colspan=2>majoria";
    newRow.insertCell(-1).outerHTML=`<td colspan=2 class=numero>${majoria}`
  }
  omple_taula_partits();

  function omple_taula_pactes(){
    let taula_pactes = document.querySelector('#pactes');
    taula_pactes.innerHTML="";

    //filtra combinacions per si tots els partits estan inclosos
    combs_inclosos = combinacions.filter(c=>{
      return c.every(p=>p.inclos);
    });

    //filtra combinacions per si tenen majoria
    let combs_majoria = combs_inclosos.filter(c=>{
      let diputats_suma = c.map(partit=>partit.escons).reduce((p,c)=>(p+c));
      return diputats_suma >= majoria;
    });

    //actualitza comptador de combinacions
    document.querySelector('#combs').innerHTML=combs_majoria.length;

    //omple taula pactes possibles
    combs_majoria.forEach(combinacio=>{
      let newRow = taula_pactes.insertRow(-1);
      let nom    = combinacio.map(partit=>partit.nom).join('<span style=color:#bbb>+</span>');
      newRow.insertCell(-1).innerHTML=nom;
      let escons = combinacio.map(partit=>partit.escons).reduce((p,c)=>(p+c));
      newRow.insertCell(-1).outerHTML=`<td class=numero>${escons}`;
    });

    //nota per si no hi ha combinacions possibles
    if(combs_majoria.length==0){
      let newRow = taula_pactes.insertRow(-1);
      newRow.insertCell(-1).outerHTML="<td colspan=2><small>cap combinació possible</small>"
    }
  }

  //executa funció omplir pactes quan es carrega la pàgina
  window.addEventListener('load',omple_taula_pactes,false);
</script>
